<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æƒ…ä¾£åŒäººæ‰«é›·</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-grad-a: #ffe4e6; /* pink-100 */
      --bg-grad-b: #f5f3ff; /* indigo-50 */
      --primary: #ef4444;   /* red-500 */
      --secondary: #06b6d4; /* cyan-500 */
      --accent: #8b5cf6;    /* violet-500 */
      --cell-light: #e2e8f0; /* slate-300 */
      --cell-dark: #cbd5e1;  /* slate-400 */
      --border: #9ca3af;     /* gray-400 */
      --border-revealed: #6b7280; /* gray-500 */
      --mine-bg: #fde8e8;    /* red-100 */
      --mine-border: #ef4444; /* red-500 */
      --last-outline: #f59e0b; /* amber-500 */
    }
    body {
      margin: 0; min-height: 100vh; font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto;
      background: linear-gradient(135deg, var(--bg-grad-a), var(--bg-grad-b));
    }
    .container { max-width: 920px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.08); padding: 16px; margin-bottom: 16px; }
    .title { text-align: center; }
    .title h1 { font-size: 32px; margin: 10px 0 6px; letter-spacing: .5px; background: linear-gradient(90deg, #f43f5e, #8b5cf6); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .subtitle { color: #6b7280; font-size: 14px; line-height: 1.5; }

    .status { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .player { text-align: center; }
    .pill { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 800; margin: 0 auto 6px; }
    .pill.p1 { background: var(--primary); }
    .pill.p2 { background: var(--secondary); }
    .current { text-align: center; }
    .current .who { font-size: 18px; font-weight: 800; color: #374151; }
    .current .hint { font-size: 12px; color: #9ca3af; }
    .counts { font-size: 12px; color: #6b7280; }
    .highlight { color: var(--accent); font-weight: 800; }

    .board-wrap { text-align: center; }
    .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; max-width: 640px; margin: 0 auto; }
    .cell { position: relative; aspect-ratio: 1; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all .2s ease; }
    .cell.light { background: var(--cell-light); }
    .cell.dark { background: var(--cell-dark); }
    .cell:hover { transform: translateY(-2px); box-shadow: 0 8px 22px rgba(0,0,0,.10); border-color: var(--accent); }
    .cell.revealed { background: #fff; border-color: var(--border-revealed); }
    .cell.last { box-shadow: 0 0 0 3px var(--last-outline); }
    .cell .content { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; }
    .cell.mine.revealed { background: var(--mine-bg); border-color: var(--mine-border); }

    /* æ•°å­—é¢œè‰²å¢å¼ºï¼ˆç»å…¸æ‰«é›·é…è‰²ï¼‰ */
    .cell.revealed .content.num0 { color: #9ca3af; }
    .cell.revealed .content.num1 { color: #1d4ed8; }
    .cell.revealed .content.num2 { color: #16a34a; }
    .cell.revealed .content.num3 { color: #dc2626; }
    .cell.revealed .content.num4 { color: #4f46e5; }
    .cell.revealed .content.num5 { color: #b91c1c; }
    .cell.revealed .content.num6 { color: #0d9488; }
    .cell.revealed .content.num7 { color: #111827; }
    .cell.revealed .content.num8 { color: #6b7280; }

    /* è¸©é›·ç‰¹æ•ˆ */
    @keyframes shake { 0%,100%{ transform: translate(0,0);} 20%{ transform: translate(-2px,0);} 40%{ transform: translate(2px,0);} 60%{ transform: translate(-2px,0);} 80%{ transform: translate(2px,0);} }
    @keyframes flash { 0%{ box-shadow: 0 0 0 rgba(239,68,68,0);} 50%{ box-shadow: 0 0 16px rgba(239,68,68,.8);} 100%{ box-shadow: 0 0 0 rgba(239,68,68,0);} }
    .boom { animation: shake .35s ease, flash .8s ease; }

    .controls { text-align: center; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 10px; border: none; cursor: pointer; font-weight: 800; background: #e5e7eb; }
    .btn-primary { background: #8b5cf6; color: #fff; }
    .btn-secondary { background: #06b6d4; color: #fff; }
    .btn:hover { opacity: .9; }

    /* ç®€æ˜“å¼¹çª—æ ·å¼ï¼ˆå…¼å®¹æ€§å¼ºï¼‰ */
    dialog.modal { border: none; border-radius: 16px; padding: 0; width: 90%; max-width: 420px; }
    .modal-box { padding: 16px; }
    .modal-action { display: flex; justify-content: flex-end; padding-top: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ ‡é¢˜ -->
    <div class="card title">
      <h1>ğŸ’• æƒ…ä¾£åŒäººæ‰«é›· ğŸ’•</h1>
      <div class="subtitle">8Ã—8 ç½‘æ ¼ï¼Œéšæœº 15 é›·ï¼›è½®æµç‚¹å‡»ï¼Œæ¯äººæ¯å›åˆä¸€æ¬¡ã€‚è¸©é›·è§¦å‘ç”œèœœä»»åŠ¡ä¸ç‚«é…·ç‰¹æ•ˆï¼›å…ˆè¸©æ»¡ 8 é¢—å³ç»“æŸï¼Œè¾“æ–¹æ¥å—è½»æ¾æœ‰è¶£çš„æƒ©ç½šï½</div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="card status">
      <div class="player">
        <div class="pill p1">â¶</div>
        <div>ç©å®¶1</div>
        <div class="counts">å·²è¸©é›·ï¼š<span id="p1Mines">0</span></div>
      </div>

      <div class="current">
        <div class="who">å½“å‰ï¼š<span id="currentWho" class="highlight">ç©å®¶1</span></div>
        <div class="hint">æ¯äººæ¯å›åˆç‚¹å‡» 1 æ¬¡</div>
      </div>

      <div class="player">
        <div class="pill p2">â·</div>
        <div>ç©å®¶2</div>
        <div class="counts">å·²è¸©é›·ï¼š<span id="p2Mines">0</span></div>
      </div>
    </div>

    <!-- æ£‹ç›˜ -->
    <div class="card board-wrap">
      <div id="board" class="board"></div>
    </div>

    <!-- æ§åˆ¶ -->
    <div class="card controls">
      <button class="btn" id="resetBtn">é‡æ–°å¼€å§‹</button>
    </div>
  </div>

  <!-- ä»»åŠ¡å¼¹çª— -->
  <dialog id="taskModal" class="modal">
    <div class="modal-box">
      <h3 style="font-weight:800; font-size:18px; color:#ef4444;">ç”œèœœä»»åŠ¡</h3>
      <div id="taskContent" style="margin-top:10px; color:#374151;"></div>
      <div class="modal-action">
        <button class="btn btn-secondary" id="taskDone">å®Œæˆ</button>
      </div>
    </div>
  </dialog>

  <!-- ç»“æŸå¼¹çª— -->
  <dialog id="endModal" class="modal">
    <div class="modal-box">
      <h3 style="font-weight:800; font-size:18px; color:#8b5cf6;">æ¸¸æˆç»“æŸ</h3>
      <div id="endContent" style="margin-top:10px; color:#374151;"></div>
      <div class="modal-action">
        <button class="btn btn-primary" id="endReset">é‡æ–°å¼€å§‹</button>
      </div>
    </div>
  </dialog>

  <script>
    const ROWS = 8, COLS = 8;
    const TOTAL = ROWS * COLS; // 64
    const TOTAL_MINES = 15;
    const WIN_THRESHOLD = 8; // æŸæ–¹å…ˆè¸©åˆ°8é¢—é›·å°±ç»“æŸ

    const taskList = [
      "ç»™å¯¹æ–¹ä¸€ä¸ªç”œèœœçš„æ‹¥æŠ± ğŸ¤—",
      "è¯´ä¸€å¥æƒ…è¯è®©å¯¹æ–¹è„¸çº¢ ğŸ˜Š",
      "ä¸€èµ·è‡ªæ‹ä¸€å¼ ç”œèœœåˆç…§ ğŸ“¸",
      "ç»™å¯¹æ–¹ä¸€ä¸ªæ¸©æŸ”çš„å» ğŸ’‹",
      "ä¸ºå¯¹æ–¹å†™ä¸€æ¡å½©è™¹å± âœï¸",
      "äº’æ¢æ‰‹æœºå£çº¸ä¸€å¤© ğŸ“±",
      "åˆ†äº«ä¸€ä¸ªå°ç§˜å¯†ï¼ˆä¸è®¸æ•·è¡ï¼‰ ğŸ¤«",
      "å­¦å¯¹æ–¹æœ€å¯çˆ±çš„è¡¨æƒ…å¹¶æ‹ç…§ ğŸ˜œ",
      "ç”¨æ‰‹æ¯”å¿ƒä¸€èµ·æ‹ç…§ ğŸ’",
      "çº¦å®šä¸‹ä¸€æ¬¡çº¦ä¼šçš„è®¡åˆ’ ğŸ“…",
      "äº²å»å¯¹æ–¹æ‰‹èƒŒæˆ–é¢å¤´ ğŸ’–",
      "è½»è½»ææå¯¹æ–¹çš„è„¸é¢Š ğŸŒ¸",
      "ä¸€èµ·è·³10ç§’çš„å°èˆè¹ˆ ğŸ’ƒğŸ•º",
      "è®²ä¸€ä¸ªå†·ç¬‘è¯ï¼Œçœ‹è°å…ˆç¬‘ ğŸ§ŠğŸ˜‚",
      "è¯´ç¬¬ä¸€æ¬¡è§é¢æ—¶çš„å¿ƒåŠ¨ç¬é—´ âœ¨",
      "äº’ç›¸å¤¸èµä»Šå¤©çš„ç©¿æ­å¹¶è¯„åˆ† ğŸ‘—ğŸ‘”",
      "ä¸€èµ·å›å¿†ä¸€æ¬¡æœ€éš¾å¿˜çš„æ—…è¡Œç‰‡æ®µ ğŸ§­",
      "ä¸ºå¯¹æ–¹å”±ä¸€æ®µæœ€æ‹¿æ‰‹çš„æ­Œè¯ ğŸ¤",
      "ç”¨ä¸‰å¥è¯æç»˜å¯¹æ–¹çš„å¯çˆ±ä¹‹å¤„ ğŸ¥°",
      "æ‚„æ‚„åœ¨çº¸ä¸Šå†™ä¸‹å¯¹æ–¹çš„ä¸‰ä¸ªä¼˜ç‚¹ ğŸ“",
      "ä¸€èµ·åˆ¶å®šä¸€å‘¨çš„å°ç›®æ ‡å¹¶äº’ç›¸ç›‘ç£ âœ…",
      "äº’ç›¸ç”»ä¸€ä¸ªç®€ç¬”å¤´åƒå¹¶å±•ç¤º ğŸ¨",
      "å‘ä¸€æ¡ç”œèœœåŠ¨æ€ï¼ˆä»…å¯¹å½¼æ­¤å¯è§ï¼‰ ğŸ“²",
      "ä¸ºå¯¹æ–¹åšä¸€ä¸ªå°å°çš„æ‰‹éƒ¨æŒ‰æ‘© ğŸ’†â€â™€ï¸",
      "ä¸€èµ·åš10ä¸ªåŒæ­¥æ·±å‘¼å¸ï¼Œæ„Ÿå—å¿ƒè·³ ğŸ’“",
      "åˆ†äº«ä¸€æœ¬æœ€è¿‘æƒ³è¯»çš„ä¹¦å¹¶çº¦å®šæ—¥æœŸ ğŸ“š",
      "äº’ç›¸äº¤æ¢ä¸€ä¸ªå¯çˆ±çš„å°ç¤¼ç‰©ï¼ˆå¯è‡ªåˆ¶ï¼‰ ğŸ",
      "ä¸€èµ·æ¨¡ä»¿ä¸€æ®µå½¼æ­¤çš„å£å¤´ç¦…å¹¶å½•éŸ³ ğŸ™ï¸",
      "å…±åŒå®Œæˆä¸€ä¸ªå°æ¸¸æˆï¼ˆå‰ªåˆ€çŸ³å¤´å¸ƒï¼‰ âœŒï¸",
      "çº¦å®šä¸‹æ¬¡è§é¢è¦å®ç°çš„ä¸€ä»¶å°äº‹ ğŸ“Œ"
    ];

    let state = {
      currentPlayer: 1,
      p1Mines: 0,
      p2Mines: 0,
      revealed: 0,
      isGameOver: false,
      lastClicked: -1,
      board: [] // {hasMine, revealed, adjacent}
    };

    function secureRandomInt(min, max) {
      const range = max - min + 1;
      if (window.crypto && window.crypto.getRandomValues) {
        const buf = new Uint32Array(1);
        window.crypto.getRandomValues(buf);
        return min + (buf[0] % range);
      }
      return min + Math.floor(Math.random() * range);
    }

    function randomMines() {
      const set = new Set();
      while (set.size < TOTAL_MINES) {
        set.add(secureRandomInt(0, TOTAL - 1));
      }
      return set;
    }

    function idx(r, c) { return r * COLS + c; }

    function neighbors(index) {
      const r = Math.floor(index / COLS), c = index % COLS;
      const res = [];
      for (let dr = -1; dr <= 1; dr++) {
        for (let dc = -1; dc <= 1; dc++) {
          if (dr === 0 && dc === 0) continue;
          const nr = r + dr, nc = c + dc;
          if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
            res.push(idx(nr, nc));
          }
        }
      }
      return res;
    }

    function calcAdjacents() {
      for (let i = 0; i < TOTAL; i++) {
        if (state.board[i].hasMine) { state.board[i].adjacent = 0; continue; }
        const ns = neighbors(i);
        let cnt = 0;
        for (const ni of ns) cnt += state.board[ni].hasMine ? 1 : 0;
        state.board[i].adjacent = cnt;
      }
    }

    function initGame() {
      state.currentPlayer = 1; state.p1Mines = 0; state.p2Mines = 0; state.revealed = 0; state.isGameOver = false; state.lastClicked = -1;
      const mines = randomMines();
      state.board = new Array(TOTAL).fill(null).map((_, i) => ({ hasMine: mines.has(i), revealed: false, adjacent: 0 }));
      calcAdjacents();
      buildBoardUI();
      updateStatus();
    }

    function buildBoardUI() {
      const boardEl = document.getElementById('board');
      boardEl.innerHTML = '';
      for (let i = 0; i < TOTAL; i++) {
        const cell = document.createElement('div');
        const r = Math.floor(i / COLS), c = i % COLS;
        cell.className = 'cell ' + (((r + c) % 2 === 0) ? 'light' : 'dark');
        cell.dataset.index = i;
        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = '';
        cell.appendChild(content);
        cell.addEventListener('click', onCellClick);
        boardEl.appendChild(cell);
      }
    }

    function updateStatus() {
      document.getElementById('p1Mines').textContent = state.p1Mines;
      document.getElementById('p2Mines').textContent = state.p2Mines;
      document.getElementById('currentWho').textContent = state.currentPlayer === 1 ? 'ç©å®¶1' : 'ç©å®¶2';
    }

    function onCellClick(e) {
      const taskModal = document.getElementById('taskModal');
      if (state.isGameOver || (taskModal && taskModal.open)) return;
      const index = parseInt(e.currentTarget.dataset.index, 10);
      const cell = state.board[index];
      if (cell.revealed) return;

      revealCell(index);
      checkEnd();
      if (!state.isGameOver) {
        // æ¯æ¬¡ç‚¹å‡»ååˆ‡æ¢åˆ°å¦ä¸€ä½
        state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
        updateStatus();
      }
    }

    function revealCell(index) {
      const cellState = state.board[index];
      const boardEl = document.getElementById('board');
      const cellEl = boardEl.children[index];
      const content = cellEl.querySelector('.content');
      cellState.revealed = true;
      cellEl.classList.add('revealed');
      state.revealed++;

      // é«˜äº®æœ€è¿‘ä¸€æ¬¡ç‚¹å‡»ä½ç½®
      if (state.lastClicked >= 0) {
        const prevEl = boardEl.children[state.lastClicked];
        if (prevEl) prevEl.classList.remove('last');
      }
      cellEl.classList.add('last');
      state.lastClicked = index;

      if (cellState.hasMine) {
        // è¸©é›·ï¼šç‰¹æ•ˆ + è®°åˆ† + ä»»åŠ¡
        cellEl.classList.add('mine');
        content.textContent = 'ğŸ’£';
        cellEl.classList.add('boom');
        if (state.currentPlayer === 1) state.p1Mines++; else state.p2Mines++;
        updateStatus();
        showTask();
      } else {
        // å®‰å…¨æ ¼ï¼šæ˜¾ç¤ºç›¸é‚»é›·æ•°ï¼ˆå«0ï¼‰å¹¶å¢åŠ æ•°å­—é¢œè‰²å¯¹æ¯”
        const adj = cellState.adjacent;
        content.textContent = String(adj);
        content.classList.remove('num0','num1','num2','num3','num4','num5','num6','num7','num8');
        content.style.color = '';
        content.classList.add('num' + adj);
      }
    }

    function showTask() {
      const taskModal = document.getElementById('taskModal');
      const taskContent = document.getElementById('taskContent');
      const taskDone = document.getElementById('taskDone');
      const randomTask = taskList[secureRandomInt(0, taskList.length - 1)];
      taskContent.innerHTML = `<p style="font-size:16px;">${randomTask}</p><p style="font-size:12px;color:#9ca3af;margin-top:6px;">å®Œæˆåç‚¹å‡»â€œå®Œæˆâ€ç»§ç»­</p>`;
      if (typeof taskModal.showModal === 'function') taskModal.showModal();
      taskDone.onclick = () => taskModal.close();
    }

    function checkEnd() {
      // æ¡ä»¶ï¼šå…¨éƒ¨ç‚¹å®Œ æˆ– æŸæ–¹å…ˆè¸©åˆ°8é¢—é›·
      if (state.revealed === TOTAL) {
        endGame('å…¨éƒ¨æ ¼å­å·²ç‚¹å®Œ');
        return;
      }
      if (state.p1Mines >= WIN_THRESHOLD || state.p2Mines >= WIN_THRESHOLD) {
        const winner = state.p1Mines >= WIN_THRESHOLD ? 'ç©å®¶1' : 'ç©å®¶2';
        endGame(`${winner} å…ˆè¸©åˆ° ${WIN_THRESHOLD} é¢—é›·`);
      }
    }

    function endGame(reason) {
      state.isGameOver = true;
      const endModal = document.getElementById('endModal');
      const endContent = document.getElementById('endContent');
      const loser = state.p1Mines > state.p2Mines ? 'ç©å®¶2' : (state.p2Mines > state.p1Mines ? 'ç©å®¶1' : 'åŒæ–¹å¹³å±€');
      const punish = loser === 'åŒæ–¹å¹³å±€' ? 'æ‹¥æŠ±å’Œè§£å§ ğŸ’' : `${loser} æ¥å—æŒ¨æ‰“æƒ©ç½šï¼ˆè½»æ¾æœ‰è¶£åœ°ç©~ï¼‰ğŸ¥Š`;
      endContent.innerHTML = `
        <p style="margin:4px 0;">ç»“æŸåŸå› ï¼š<strong>${reason}</strong></p>
        <p style="margin:4px 0;">ç©å®¶1è¸©é›·ï¼š<strong>${state.p1Mines}</strong>ï¼Œç©å®¶2è¸©é›·ï¼š<strong>${state.p2Mines}</strong></p>
        <p style="margin:6px 0; color:#ef4444;">${punish}</p>
      `;
      if (typeof endModal.showModal === 'function') endModal.showModal();
    }

    function resetGame() {
      const taskModal = document.getElementById('taskModal');
      const endModal = document.getElementById('endModal');
      if (taskModal && taskModal.open) taskModal.close();
      if (endModal && endModal.open) endModal.close();
      initGame();
    }

    // åˆå§‹åŒ–
    initGame();
    document.getElementById('resetBtn').addEventListener('click', resetGame);
    document.getElementById('endReset').addEventListener('click', resetGame);
  </script>
</body>
</html>